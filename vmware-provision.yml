---
- name: Build a VMware guest from template
  hosts: localhost
  gather_facts: no
  tasks:
  - include_role:
      name: vmware-provision

- name: Standardize the new vm
  hosts: newlinuxvm
  vars:
  - motd_template_file: templates/motd_gokev_bw
  roles:
  - prep-new-vm
  - vm-reboot
  - motd-splash
  - kev-nano

- name: Standardize the new windows vm
  hosts: newwindowsvm
  roles:
  - prep-new-windows

- name: Create Unbound DNS Entries on OpnSense
  hosts: newlinuxvm,newwindowsvm
  vars:
    host: gokevtest01
    domain: lab
    host_ip: 10.0.30.123
    host_desc: gokevestdesc

  tasks:

  - name: Insert a static DHCP map for OPNsense
    blockinfile:
      path: /conf/config.xml
      marker: "  <dhcpd>"
      insertbefore: "    </lan>"
      block: |
        <staticmap>
          <mac>{{ hostvars[inventory_hostname].ansible_default_ipv4.macaddress }}</mac>
          <cid>{{ name_hostonly }}</cid>
          <ipaddr>10.0.30.123</ipaddr>
          <hostname>{{ name_hostonly }}</hostname>
          <winsserver/>
          <dnsserver/>
          <ntpserver/>
        </staticmap>
    delegate_to: 10.0.30.1
    when: no
